# 变量助手扩展 (Variable Helper Extension)

这是一个为SillyTavern设计的扩展，提供更自然、直观的变量语法，简化变量的设置和获取操作。新增条件判断功能，支持基于变量值的动态内容显示。

## 功能特点

- **自然语法**：使用类似编程语言的语法来操作变量
- **自动转换**：自动将自然语法转换为SillyTavern内置的变量宏
- **条件判断**：支持PHP风格的条件语法，根据变量值动态显示内容
- **调试模式**：可查看变量转换过程，便于调试
- **实时处理**：通过Prompt Interceptor在消息发送前自动处理变量语法

## 语法对比

### 传统语法 vs 新语法

| 操作 | 传统语法 | 新语法 |
|------|---------|--------|
| 设置变量 | `{{setvar::好感度::100}}` | `@好感度 = 100` |
| 获取变量 | `{{getvar::好感度}}` | `@好感度` |
| 设置字符串 | `{{setvar::名字::小明}}` | `@名字 = 小明` |
| 条件判断 | 复杂的STScript语法 | `@if(好感度 > 80): 角色会表白` |
| 条件else | 无 | `@if(好感度 > 80): 很好 @else: 一般` |

## 基本变量语法

### 基本用法

```
// 设置数值变量
@好感度 = 100
@等级 = 5
@金币 = 1500

// 设置字符串变量  
@名字 = 小明
@称号 = 勇者

// 获取变量值
你好，@名字！
你的好感度是@好感度，等级是@等级。
```

## 条件判断功能

### 语法格式

**单行条件：**
```
@if(变量名 操作符 值): 条件满足时显示的内容
```

**带else的条件：**
```
@if(变量名 操作符 值): 内容1 @else: 内容2
```

**多行条件：**
```
@if(变量名 操作符 值):
多行内容
可以换行
@end
```

### 支持的操作符

- `>` - 大于
- `<` - 小于  
- `>=` - 大于等于
- `<=` - 小于等于
- `==` - 等于
- `!=` - 不等于

### 条件判断示例

```
// 基本条件判断
@好感度 = 95
@if(好感度 > 90): 我们的关系很好呢~
当前好感度：@好感度

// 带else的条件
@if(等级 >= 10): 你是高级玩家 @else: 你是新手玩家
@if(生命值 <= 20): 状态危险 @else: 状态良好

// 字符串比较  
@if(名字 == 小明): 你好，小明同学！
@if(职业 != 战士): 你不是战士职业

// 多行条件
@if(关系状态 == 恋人):
亲爱的，今天过得怎么样？
想要一起吃晚饭吗？
@end

// 复合使用
@好感度 = 100 @if(好感度 > 80): 角色会表白
```

### 实际应用场景

```
// 角色扮演场景
@角色心情 = 开心
@关系状态 = 朋友

@if(关系状态 == 恋人): 
亲爱的，今天过得怎么样？
@end

@if(角色心情 == 生气): 哼！我现在不想和你说话！

// 游戏数据管理  
@生命值 = 100
@魔法值 = 30

@if(生命值 < 30): 你的状态看起来很糟糕，需要休息一下。
@if(魔法值 >= 50): 你感到魔法力量在体内涌动！ @else: 魔法力量不足

// 复杂逻辑组合
@等级 = 15
@职业 = 法师
@if(等级 >= 10): 你已经很有经验了 @if(职业 == 法师): ，作为法师你掌握了强大的魔法
```

## 支持的变量名

- 支持中文、英文、数字和下划线
- 变量名必须以字母或下划线开头
- 例如：`好感度`、`level`、`_temp`、`用户名`、`user_id` 等

## 安装说明

1. 将此扩展文件夹放入 `data/<username>/extensions/` 目录
2. 重启SillyTavern或刷新页面
3. 在设置页面的"扩展"部分找到"变量助手"
4. 启用扩展并根据需要开启条件判断功能和调试模式

## 设置选项

- **启用变量助手**：开启/关闭变量语法转换功能
- **启用条件判断功能**：开启/关闭条件语法处理
- **调试模式**：在控制台显示变量转换的详细信息
- **测试变量解析**：点击按钮测试各种变量语法的转换结果

## 注意事项

1. 所有语法都以 `@` 开头，语法统一简洁
2. 变量设置无需分号结尾：`@变量名 = 值`
3. 条件语法使用冒号：`@if(条件): 内容`
4. 多行条件用 `@end` 结束：`@if(条件): 内容 @end`
5. 变量名区分大小写，支持中文、英文、数字和下划线
6. 条件满足时，LLM只会看到条件内容，条件语句本身会被隐藏
7. 启用调试模式后可在浏览器控制台(F12)查看转换过程
8. SillyTavern不区分数字和字符串类型，所有值都按字符串处理

## 兼容性

- 兼容SillyTavern最新版本
- 与现有的变量宏语法完全兼容
- 不会影响其他扩展的正常运行
- 条件判断完全由扩展自行实现，无需依赖外部系统

## 技术实现

### 条件判断的工作原理

由于SillyTavern本身没有内置的条件语句功能，本扩展完全自行实现了条件判断逻辑：

1. **变量状态管理**：在Prompt Interceptor中维护整个聊天过程的变量状态
2. **实时条件评估**：解析条件语法时，获取当前变量值并进行实际的条件比较
3. **动态内容显示**：根据条件结果决定是否显示内容给LLM

### 处理流程

1. 用户输入包含变量和条件的文本
2. Prompt Interceptor拦截消息处理
3. 提取当前消息中的变量赋值
4. 解析条件语句，获取变量当前值
5. 执行条件评估（数值/字符串比较）
6. 根据结果显示或隐藏条件内容
7. LLM只看到最终处理后的内容

## 项目结构

```
variable-helper/
├── index.js        # 主扩展脚本
├── settings.html   # 设置界面HTML
├── style.css       # 样式文件
├── manifest.json   # 扩展配置文件
├── README.md       # 项目说明文档
└── .gitignore     # Git忽略文件
```

## 版本历史

- **3.0.1** - 修复多行条件精确匹配：
  - 修复多行条件贪婪匹配跨越其他@if语句的问题
  - 使用负向前瞻`(?!@if|@end)`避免跨越边界
  - 采用循环处理确保从内到外正确解析嵌套条件
  - 优化处理顺序：多行条件 → if-else → 单行条件
- **3.0.0** - 架构重构：直接条件处理
  - **重大改进**：完全移除中间宏步骤，直接处理条件判断
  - 从 `@if语法 → vh-if宏 → 条件判断` 简化为 `@if语法 → 条件判断`
  - 大幅提升性能和可靠性，减少中间转换错误
  - 修复>=、<=操作符优先级匹配问题
  - 删除不再需要的processConditionalMacros函数
- **2.0.2** - 修复正则表达式和处理顺序问题
- **2.0.1** - 修复重要问题：if-else逻辑、数字比较、调试日志
- **2.0.0** - 完全重构，采用@语法，支持统一的变量和条件语法
- **1.2.0** - 简化条件判断逻辑，去掉字符串引号处理 
- **1.1.0** - 新增条件判断功能，支持多种条件语法
- **1.0.0** - 基础变量助手功能

## 开发信息

- **版本**：3.0.1
- **作者**：变量助手开发者
- **许可证**：开源许可

## 反馈与支持

如果您在使用过程中遇到问题或有改进建议，欢迎反馈！
