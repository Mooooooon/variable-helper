# 变量助手扩展 (Variable Helper Extension)

这是一个为SillyTavern设计的扩展，提供更自然、直观的变量语法，简化变量的设置和获取操作。新增条件判断功能，支持基于变量值的动态内容显示。

## 功能特点

- **自然语法**：使用类似编程语言的语法来操作变量
- **自动转换**：自动将自然语法转换为SillyTavern内置的变量宏
- **完整条件系统**：支持if、else、elseif的完整条件语法体系
- **逻辑操作符**：支持与(&&/且)、或(||/或)、非(!/非)逻辑运算
- **多行支持**：支持单行和多行两种条件语法，适应不同场景
- **嵌套条件**：支持条件语句的嵌套使用，创建复杂逻辑
- **调试模式**：可查看变量转换过程，便于调试
- **实时处理**：通过Prompt Interceptor在消息发送前自动处理变量语法

## 语法对比

### 传统语法 vs 新语法

| 操作 | 传统语法 | 新语法 |
|------|---------|--------|
| 设置变量 | `{{setvar::好感度::100}}` | `@好感度 = 100` |
| 获取变量 | `{{getvar::好感度}}` | `@好感度` |
| 设置字符串 | `{{setvar::名字::小明}}` | `@名字 = 小明` |
| 条件判断 | 无 | `@if(好感度 > 80): 角色会表白` |
| 条件else | 无 | `@if(好感度 > 80): 很好 @else: 一般` |
| 多条件elseif | 无 | `@if(好感度 > 90): 恋人 @elseif(好感度 > 70): 好友 @else: 普通` |
| 多行条件 | 无 | `@if(条件): 多行内容... @else: 其他内容... @end` |
| 逻辑与操作 | 无 | `@if(好感度 > 80 && 等级 >= 10): 高好感且高等级` |
| 逻辑或操作 | 无 | `@if(生命值 <= 20 \|\| 魔法值 <= 10): 状态危险` |
| 逻辑非操作 | 无 | `@if(!(等级 < 5)): 不是新手` |

## 基本变量语法

### 基本用法

```
// 设置数值变量
@好感度 = 100
@等级 = 5
@金币 = 1500

// 设置字符串变量  
@名字 = 小明
@称号 = 勇者

// 获取变量值
你好，@名字！
你的好感度是@好感度，等级是@等级。
```

## 条件判断功能

### 完整语法总览

变量助手现在支持完整的条件语法体系：

| 语法类型 | 格式 | 示例 |
|----------|------|------|
| 单行if | `@if(条件): 内容` | `@if(好感度 > 80): 角色会表白` |
| 单行if-else | `@if(条件): 内容1 @else: 内容2` | `@if(等级 >= 10): 高级 @else: 新手` |
| 单行elseif | `@if(条件1): 内容1 @elseif(条件2): 内容2 @else: 内容3` | `@if(好感度 > 90): 恋人 @elseif(好感度 > 70): 好友 @else: 普通` |
| 多行if | `@if(条件): 内容 @end` | `@if(状态 == 战斗): 战斗中... @end` |
| 多行if-else | `@if(条件): 内容1 @else: 内容2 @end` | `@if(天气 == 晴): 好天气 @else: 坏天气 @end` |
| 多行elseif | `@if(条件1): 内容1 @elseif(条件2): 内容2 @else: 内容3 @end` | 复杂多条件多行逻辑 |
| 逻辑与条件 | `@if(条件1 && 条件2): 内容` | `@if(等级 > 10 && 好感度 > 80): 解锁特殊剧情` |
| 逻辑或条件 | `@if(条件1 \|\| 条件2): 内容` | `@if(生命值 <= 20 \|\| 魔法值 <= 10): 危险状态` |
| 逻辑非条件 | `@if(!(条件)): 内容` | `@if(!(状态 == 战斗)): 和平时光` |

### 语法格式

**单行条件：**
```
@if(变量名 操作符 值): 条件满足时显示的内容
```

**带else的条件：**
```
@if(变量名 操作符 值): 内容1 @else: 内容2
```

**elseif多条件：**
```
@if(条件1): 内容1 @elseif(条件2): 内容2 @else: 内容3
```

**多行条件：**
```
@if(变量名 操作符 值):
多行内容
可以换行
@end
```

**多行if-else：**
```
@if(变量名 操作符 值):
条件为真时的多行内容
@else:
条件为假时的多行内容  
@end
```

**多行if-elseif-else：**
```
@if(条件1):
第一个条件的内容
@elseif(条件2):
第二个条件的内容
@else:
默认情况的内容
@end
```

### 支持的操作符

### 比较操作符
- `>` - 大于
- `<` - 小于  
- `>=` - 大于等于
- `<=` - 小于等于
- `==` - 等于
- `!=` - 不等于

### 逻辑操作符
- `&&` / `且` / `并且` - 逻辑与（AND）
- `||` / `或` / `或者` - 逻辑或（OR）  
- `!` / `非` / `不是` - 逻辑非（NOT）

### 条件判断示例

```
// 基本条件判断
@好感度 = 95
@if(好感度 > 90): 我们的关系很好呢~
当前好感度：@好感度

// 带else的条件
@if(等级 >= 10): 你是高级玩家 @else: 你是新手玩家
@if(生命值 <= 20): 状态危险 @else: 状态良好

// elseif多条件判断
@if(好感度 > 90): 恋人关系 @elseif(好感度 > 70): 好友关系 @else: 普通关系
@if(等级 > 20): 专家 @elseif(等级 > 10): 老手 @elseif(等级 > 5): 新手 @else: 菜鸟

// 逻辑操作符
@if(好感度 > 80 && 等级 >= 10): 高好感度且高等级
@if(生命值 <= 20 || 魔法值 <= 10): 状态危险
@if(好感度 > 70 且 等级 > 5): 中文与操作符
@if(生命值 < 50 或 魔法值 < 30): 中文或操作符
@if(!(好感度 < 50)): 非操作符测试
@if(非(等级 < 5)): 中文非操作符

// 字符串比较  
@if(名字 == 小明): 你好，小明同学！
@if(职业 != 战士): 你不是战士职业

// 多行条件
@if(关系状态 == 恋人):
亲爱的，今天过得怎么样？
想要一起吃晚饭吗？
@end

// 多行if-else
@if(好感度 > 80):
角色露出了甜美的笑容，看起来很开心。
今天真是美好的一天！
@else:
角色表情平淡，似乎心情一般。
@end

// 多行elseif条件
@if(健康值 > 80):
你感觉精力充沛，状态极佳！
可以进行任何冒险活动。
@elseif(健康值 > 50):
你感觉还不错，但有些疲惫。
适当休息会让状态更好。
@else:
你感觉很虚弱，需要立即休息。
不要勉强自己。
@end

// 复杂逻辑组合
@if(好感度 > 80 && (等级 >= 10 || 魔法值 > 50)): 复杂条件组合
@if((生命值 > 50 && 魔法值 > 40) || 状态 == 无敌): 战斗准备完毕
@if(!(生命值 <= 20 || 魔法值 <= 10)): 状态良好

// 复合使用
@好感度 = 100 @if(好感度 > 80): 角色会表白
```

### 实际应用场景

```
// 角色关系系统
@好感度 = 85
@关系状态 = 好友

@if(好感度 > 95): 
"我爱你！"她毫不犹豫地说道。
你们现在是恋人关系。
@elseif(好感度 > 80):
"你对我很重要。"她温柔地说。
你感觉你们的关系更进一步了。
@elseif(好感度 > 60):
她对你露出友善的笑容。
你们是很好的朋友。
@else:
她对你保持着客气的距离。
你们还不是很熟悉。
@end

// 战斗系统
@生命值 = 30
@魔法值 = 80

@if(生命值 <= 20):
警告：生命值危险！建议立即使用治疗药剂。
@elseif(生命值 <= 50):
注意：生命值偏低，小心应战。
@else:
状态良好，可以正常战斗。
@end

@if(魔法值 > 50): 可以使用高级法术 @else: 只能使用基础攻击

// 高级逻辑判断
@if((生命值 > 80 && 魔法值 > 60) || 状态 == 狂暴):
你感觉状态极佳！可以发动强力攻击！
@elseif(生命值 > 50 && 魔法值 > 30):
状态不错，可以进行常规战斗。
@else:
状态不佳，建议谨慎行动。
@end

// 嵌套条件系统
@战斗状态 = 进行中
@生命值 = 30

@if(战斗状态 == 进行中):
当前正在战斗中！
@if(生命值 > 50):
继续战斗！勇敢面对敌人！
@else:
快逃跑！生命值太低了！
@end
@else:
现在是和平时光，可以好好休息。
@end
```

## 支持的变量名

- 支持中文、英文、数字和下划线
- 变量名必须以字母或下划线开头
- 例如：`好感度`、`level`、`_temp`、`用户名`、`user_id` 等

## 安装说明

1. 将此扩展文件夹放入 `data/<username>/extensions/` 目录
2. 重启SillyTavern或刷新页面
3. 在设置页面的"扩展"部分找到"变量助手"
4. 启用扩展并根据需要开启条件判断功能和调试模式

## 设置选项

- **启用变量助手**：开启/关闭变量语法转换功能
- **启用条件判断功能**：开启/关闭条件语法处理
- **调试模式**：在控制台显示变量转换的详细信息
- **测试变量解析**：点击按钮测试各种变量语法的转换结果

## 注意事项

1. 所有语法都以 `@` 开头，语法统一简洁
2. 变量设置无需分号结尾：`@变量名 = 值`
3. 条件语法使用冒号：`@if(条件): 内容`
4. 多行条件用 `@end` 结束：`@if(条件): 内容 @end`
5. **elseif语法**：可以使用多个 `@elseif` 进行链式条件判断
6. **条件优先级**：按照 if → elseif → else 的顺序评估，第一个为真的条件会被执行
7. **逻辑操作符**：支持 `&&`(且)、`||`(或)、`!`(非) 以及对应的中文操作符
8. **括号分组**：使用括号 `()` 来控制逻辑运算的优先级
9. **操作符优先级**：`!`(非) > `&&`(且) > `||`(或)，建议使用括号明确优先级
10. 变量名区分大小写，支持中文、英文、数字和下划线
11. 条件满足时，LLM只会看到条件内容，条件语句本身会被隐藏
12. **嵌套支持**：条件语句可以嵌套使用，但建议不超过3层以保持可读性
13. 启用调试模式后可在浏览器控制台(F12)查看转换过程
14. SillyTavern不区分数字和字符串类型，所有值都按字符串处理

## 兼容性

- 兼容SillyTavern最新版本
- 与现有的变量宏语法完全兼容
- 不会影响其他扩展的正常运行
- 条件判断完全由扩展自行实现，无需依赖外部系统

## 技术实现

### 条件判断的工作原理

由于SillyTavern本身没有内置的条件语句功能，本扩展完全自行实现了条件判断逻辑：

1. **变量状态管理**：在Prompt Interceptor中维护整个聊天过程的变量状态
2. **实时条件评估**：解析条件语法时，获取当前变量值并进行实际的条件比较
3. **动态内容显示**：根据条件结果决定是否显示内容给LLM

### 处理流程

1. 用户输入包含变量和条件的文本
2. Prompt Interceptor拦截消息处理
3. 提取当前消息中的变量赋值
4. 解析条件语句，获取变量当前值
5. 执行条件评估（数值/字符串比较）
6. 根据结果显示或隐藏条件内容
7. LLM只看到最终处理后的内容

## 项目结构

```
variable-helper/
├── index.js        # 主扩展脚本
├── settings.html   # 设置界面HTML
├── style.css       # 样式文件
├── manifest.json   # 扩展配置文件
├── README.md       # 项目说明文档
└── .gitignore     # Git忽略文件
```

## 版本历史

- **3.2.0** - 逻辑操作符功能实现：
  - ✅ **新增逻辑与操作符**：`&&` / `且` / `并且` 支持多条件同时满足
  - ✅ **新增逻辑或操作符**：`||` / `或` / `或者` 支持多条件任一满足
  - ✅ **新增逻辑非操作符**：`!` / `非` / `不是` 支持条件取反
  - ✅ **支持中英文操作符**：更自然的中文逻辑表达方式
  - ✅ **支持括号分组**：`(条件1 && 条件2) || 条件3` 复杂逻辑组合
  - ✅ **完整条件解析重构**：统一使用递归解析函数处理所有逻辑
  - ✅ **增强测试覆盖**：包含所有逻辑操作符的测试用例
- **3.1.0** - 完整Else功能实现：
  - ✅ **新增单行elseif功能**：`@if(条件1): 内容1 @elseif(条件2): 内容2 @else: 内容3`
  - ✅ **新增多行if-else功能**：`@if(条件): 内容1 @else: 内容2 @end`
  - ✅ **新增多行if-elseif-else功能**：支持复杂的多条件多行语法
  - ✅ **改进条件解析逻辑**：更准确的正则表达式匹配和处理顺序
  - ✅ **增强测试用例**：添加所有新功能的完整测试
  - ✅ **优化调试输出**：更详细的条件评估过程日志
- **3.0.1** - 修复多行条件精确匹配：
  - 修复多行条件贪婪匹配跨越其他@if语句的问题
  - 使用负向前瞻`(?!@if|@end)`避免跨越边界
  - 采用循环处理确保从内到外正确解析嵌套条件
  - 优化处理顺序：多行条件 → if-else → 单行条件
- **3.0.0** - 架构重构：直接条件处理
  - **重大改进**：完全移除中间宏步骤，直接处理条件判断
  - 从 `@if语法 → vh-if宏 → 条件判断` 简化为 `@if语法 → 条件判断`
  - 大幅提升性能和可靠性，减少中间转换错误
  - 修复>=、<=操作符优先级匹配问题
  - 删除不再需要的processConditionalMacros函数
- **2.0.2** - 修复正则表达式和处理顺序问题
- **2.0.1** - 修复重要问题：if-else逻辑、数字比较、调试日志
- **2.0.0** - 完全重构，采用@语法，支持统一的变量和条件语法
- **1.2.0** - 简化条件判断逻辑，去掉字符串引号处理 
- **1.1.0** - 新增条件判断功能，支持多种条件语法
- **1.0.0** - 基础变量助手功能

## 开发信息

- **版本**：3.2.0
- **作者**：@司马咩咩
- **许可证**：开源许可

## 反馈与支持

如果您在使用过程中遇到问题或有改进建议，欢迎反馈！
